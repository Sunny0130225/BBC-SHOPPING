<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BBCè¨è«–å€</title>
  
  <link rel="stylesheet" href="../32css/styles1.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- å¼•å…¥ jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <header class="navbar">
    <div class="header-container">
      <div class="logo">
        <a href="http://localhost:8081/32home/HomeReview5.html">
          <img src="../32images/BBC.png" alt="BBC Logo">
          <span>BBCè¨è«–å€</span>
        </a>
      </div>
      <nav></nav>
      <div class="header-icons">
        <input type="text" id="searchInput" class="search-input" placeholder="è¼¸å…¥é—œéµå­—å¾ŒæŒ‰ Enter">
        <button class="search-btn" onclick="toggleSearchBox()">ğŸ”</button>

        <img src="../32images/B13.jpg" alt="æœƒå“¡ä½ å¥½" title="å°Šæ¦®æœƒå“¡">
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <h1>æ­¡è¿ä¾†åˆ°BBCè¨è«–å€</h1>
      <p>åˆ†äº«æ‚¨çš„æ™‚å°šéˆæ„Ÿï¼Œæ¢ç´¢æ›´å¤šå¯èƒ½ï¼</p>
    </section>
    <section id="reviews" class="content">
      <!-- æ‰€æœ‰è²¼æ–‡å°‡åœ¨æ­¤å‹•æ…‹ç”Ÿæˆ -->
    </section>
    <div id="loadMoreContainer" class="load-more-container">
      <button id="loadMoreButton" class="load-more-btn">æŸ¥çœ‹æ›´å¤š</button>
    </div>
  </main>

  <footer class="footer">
    <p>Â© 2024 BBC. ç‰ˆæ¬Šæ‰€æœ‰ã€‚</p>
  </footer>

  <button class="floating-btn" onclick="openAddPage()">+</button>

  <!-- å»£å‘Šæ¬„ä½ -->
  <div class="ad-container">
  <a href="http://localhost:5173/customer/discount" target="_blank">
  <div class="image-container">
    <img src="../32images/AD.jpg" alt="å»£å‘Šåœ–ç‰‡">
  </div>
  </a>
</div>




  <script>
  
  function toggleSearchBox() {
      const searchInput = document.getElementById('searchInput');
      searchInput.style.display = searchInput.style.display === 'none' ? 'block' : 'none';
    }
  
  
  
  function openAddPage() {
	  Swal.fire({
	    title: 'æ–°å¢è²¼æ–‡',
	    html: `
	      <form id="InsertReviewForm" style="display: flex; flex-direction: column; gap: 16px;">
	        <div style="margin-bottom: 16px;">
	          <label for="userId">ä½¿ç”¨è€… ID:</label>
	          <input type="text" id="userId" name="userId" required>
	        </div>
	        <div style="margin-bottom: 16px;">
	          <label for="product">è²¼æ–‡åç¨±:</label>
	          <input type="text" id="product" name="product" required>
	        </div>
	        <div style="margin-bottom: 16px;">
	          <label for="product_id">è²¼æ–‡ç·¨ç¢¼:</label>
	          <input type="text" id="product_id" name="product_id" required>
	        </div>
	        <div style="margin-bottom: 16px;">
	          <label for="productPicture">ä¸Šå‚³åœ–ç‰‡:</label>
	          <input type="file" id="productPicture" name="productPicture" accept="image/*">
	        </div>        
	        <div style="margin-bottom: 16px;">
	          <label for="content">å…§å®¹:</label>
	          <textarea id="content" name="content" style="width: 100%; resize: vertical;" rows="5" required></textarea>
	        </div>
	        <div style="margin-bottom: 16px;">
	          <label for="rating">æ¨è–¦æ˜Ÿæ˜Ÿ:</label>
	          <div id="ratingStars">
	            <i class="fa fa-star" onclick="setRating(1)"></i>
	            <i class="fa fa-star" onclick="setRating(2)"></i>
	            <i class="fa fa-star" onclick="setRating(3)"></i>
	            <i class="fa fa-star" onclick="setRating(4)"></i>
	            <i class="fa fa-star" onclick="setRating(5)"></i>
	          </div>
	          <input type="hidden" id="rating" name="rating" required>
	        </div>
	        <div style="margin-bottom: 16px;">
	          <label for="status">ç™¼è¡¨è²¼æ–‡å¸³è™Ÿç‹€æ…‹:</label>
	          <select id="status" name="status" required>
	            <option value="active">å¸³è™Ÿæ­£å¸¸ä½¿ç”¨ä¸­</option>
	            <option value="deleted">å¸³è™Ÿå·²åˆªé™¤</option>
	            <option value="flagged">å¸³è™Ÿç•°å¸¸</option>
	          </select>
	        </div>
	        
	        </form>
	        `,
	        showCancelButton: true,
	        confirmButtonText: 'ç¢ºèªé€å‡º',
	        cancelButtonText: 'å–æ¶ˆ',
	        preConfirm: () => {
	          const form = document.getElementById('InsertReviewForm');
	          if (!form.checkValidity()) {
	            Swal.showValidationMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
	            return false;
	          }
	          const formData = new FormData(form);
	          const productPicture = form.productPicture.files[0];
	          if (productPicture) {
	            formData.append('productPicture', productPicture);
	          }
	          return formData;
	        },
	      }).then((result) => {
	        if (result.isConfirmed) {
	          submitReview(result.value);
	        }
	      });
	    }


  function submitReview() {
	  const form = document.getElementById('InsertReviewForm');
	  const formData = new FormData();

	  formData.append('review', JSON.stringify({
	    userId: form.userId.value,
	    product: form.product.value,
	    productId: form.product_id.value,
	    content: form.content.value,
	    rating: form.rating.value,
	    status: form.status.value,
	  }));

	  const productPicture = form.productPicture.files[0];
	  if (productPicture) {
	    formData.append('productPicture', productPicture);
	  }

	  fetch('http://localhost:8081/review/insert', {
	    method: 'POST',
	    body: formData,
	  })
	    .then(response => response.json())
	    .then(data => {
	      if (data.success) {
	        Swal.fire('æˆåŠŸ', 'è²¼æ–‡æ–°å¢æˆåŠŸ', 'success').then(() => {
	          window.location.href = 'http://localhost:8081/32home/HomeReview5.html';
	        });
	      } else {
	        Swal.fire('éŒ¯èª¤', data.message || 'æ–°å¢å¤±æ•—', 'error');
	      }
	    })
	    .catch(() => Swal.fire('éŒ¯èª¤', 'è«‹æ±‚å¤±æ•—', 'error'));
	}
 
    
    //æ–°å¢åŠŸèƒ½çš„è®“æ˜Ÿæ˜Ÿé¡¯ç¤ºäº’å‹•ï¼š
    function setRating(value) {
    	  const stars = document.querySelectorAll('#ratingStars .fa-star');
    	  stars.forEach((star, index) => {
    	    star.style.color = index < value ? 'gold' : 'gray';
    	  });
    	  document.getElementById('rating').value = value;
    	}


    
    
    
 // å‹•æ…‹ç”Ÿæˆè©•åƒ¹å€å¡Š
 function addReview(review) {
  const reviewsContainer = document.getElementById("reviews");
  const reviewBlock = document.createElement("div");
  reviewBlock.className = "review-item section-block";

  // æ˜Ÿæ˜Ÿ
  const stars = Array(5).fill('<i class="fa fa-star" style="color: gray;"></i>');
  for (let i = 0; i < review.rating; i++) {
    stars[i] = '<i class="fa fa-star" style="color: gold;"></i>';
  }

  // è™•ç†ç”¢å“åœ–ç‰‡
  const productImage = review.productPicture
    ? `<img src="data:image/jpeg;base64,${review.productPicture}" alt="Product Image" class="product-image">`
    : '<p>æ²’æœ‰åœ–ç‰‡</p>';
    
    
    

  // å–å¾—æ„›å¿ƒé»æ“Šçš„ç¸½æ¬¡æ•¸ï¼Œè‹¥å°šæœªè¨­å®šå‰‡åˆå§‹åŒ–ç‚º 0
  let likeCount = parseInt(localStorage.getItem(`likeCount-${review.productId}`)) || 0;

//æˆªå–å‰20å€‹å­—ä½œç‚ºé è¦½å…§å®¹ï¼Œä¸¦æ·»åŠ  "æ›´å¤š" æŒ‰éˆ•
  const shortContent = review.content.length > 20 ? review.content.slice(0, 20) + '...' : review.content;
  const fullContent = review.content; // å®Œæ•´å…§å®¹
  
//å‹•æ…‹ç”Ÿæˆ HTML
  reviewBlock.innerHTML = `
    <div class="review-container">
      <div class="image-container">
        ${productImage}
      </div>
      <div class="text-container">
        <h3>${review.product}</h3>
        <p><strong>è²¼æ–‡å…§å®¹:</strong><br>
        <span class="content-preview">${shortContent}</span>
        <span class="full-content" style="display:none;">${fullContent}</span>
        <span class="more-link" style="display:${review.content.length > 20 ? 'inline' : 'none'};">è¼‰å…¥æ›´å¤š...</span>
      </p>
        <p><strong>æ¨è–¦æ˜Ÿæ˜Ÿ:</strong> ${stars.join(' ')}</p>
        <p><strong>ç™¼è¡¨è²¼æ–‡å¸³è™Ÿç‹€æ…‹:</strong> ${getStatusText(review.status)}</p>
        <p><strong>å»ºç«‹æ™‚é–“:</strong> ${new Date(review.createdAt).toLocaleString()}</p>
        <p><strong>æœ€æ–°æ›´æ–°æ™‚é–“:</strong> ${new Date(review.updatedAt).toLocaleString()}</p>
        <button onclick="confirmDelete(${review.userId}, ${review.productId})"><i class="fas fa-trash"></i> åˆªé™¤è²¼æ–‡</button>
        <button class="edit-button" onclick="editReview(${review.id})"><i class="fas fa-edit"></i> ç·¨è¼¯è²¼æ–‡</button>
        
        <!-- æ„›å¿ƒæŒ‰éˆ• -->
        <span class="heart-button" onclick="toggleHeart(this, ${review.productId})">
          <i class="fas fa-heart"></i> 
          <span class="like-count">${likeCount}</span>
          <span class="float-text" style="display: none;">å–œæ­¡</span> <!-- æµ®ç¾æ–‡å­— -->
        </span>

      
        
        <div>
        <!-- æ–°å¢ç•™è¨€æŒ‰éˆ• -->
        <button class="comment-btn" onclick="toggleComments(${review.id})">
          <i class="fa fa-comment" aria-hidden="true"></i>
        </button>
        <!-- æ–°å¢ç•™è¨€æŒ‰éˆ• -->
        <button class="insert-btn" data-review-id="${review.id}">æ–°å¢ç•™è¨€</button>
        
        <div style="margin-bottom: 16px;">
        </div>
        <!-- ç•™è¨€å€åŸŸ (éš±è—ï¼Œé»æ“Šç•™è¨€æŒ‰éˆ•å¾Œé¡¯ç¤º) -->
        <div id="comments-${review.id}" class="comments-container" style="display: none;">
          <!-- ç•™è¨€æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>
        
        
      </div>
    </div>
  </div>
`;                
  
  
  
  // ç›£è½è²¼æ–‡çš„ã€Œæ›´å¤šã€æ–‡å­—é€£çµé»æ“Šäº‹ä»¶
const moreLink = reviewBlock.querySelector('.more-link');
moreLink?.addEventListener('click', () => {
  const preview = reviewBlock.querySelector('.content-preview');
  const full = reviewBlock.querySelector('.full-content');
  const link = reviewBlock.querySelector('.more-link');

  if (preview.style.display === 'none') {
    preview.style.display = 'inline';
    full.style.display = 'none';
    link.textContent = 'è¼‰å…¥æ›´å¤š...';
  } else {
    preview.style.display = 'none';
    full.style.display = 'inline';
    link.textContent = 'æ”¶èµ·...';
  }
});
  
  // æª¢æŸ¥ localStorage æ˜¯å¦æœ‰è¨˜éŒ„é€™å€‹ productId è¢«é»é¸é
  if (localStorage.getItem(`liked-${review.productId}`) === 'true') {
    const heartButton = reviewBlock.querySelector('.heart-button');
    heartButton.classList.add('liked'); // è¨­å®šå·²é»æ“Š
  }

  reviewsContainer.appendChild(reviewBlock);
}
 
 
 
 
		//åˆ‡æ›æ„›å¿ƒé¡è‰²ä¸¦å„²å­˜ç‹€æ…‹
 		function toggleHeart(button, productId) {
   		// åˆ‡æ› .liked é¡åˆ¥
   		button.classList.toggle("liked");

   		// æ›´æ–° localStorage ç‹€æ…‹
   		const isLiked = button.classList.contains("liked");
   		localStorage.setItem(`liked-${productId}`, isLiked);

   		// è®€å–ä¸¦æ›´æ–°æ„›å¿ƒæŒ‰éˆ•æ—çš„æŒ‰è®šæ¬¡æ•¸
   		let likeCount = parseInt(localStorage.getItem(`likeCount-${productId}`)) || 0;

   		// è‹¥é»æ“Šæ„›å¿ƒï¼Œå‰‡å¢åŠ è¨ˆæ•¸ï¼›è‹¥å–æ¶ˆé»æ“Šæ„›å¿ƒï¼Œå‰‡æ¸›å°‘è¨ˆæ•¸
   		likeCount = isLiked ? likeCount + 1 : likeCount - 1;

   		// å„²å­˜æ›´æ–°å¾Œçš„æŒ‰è®šæ¬¡æ•¸
   		localStorage.setItem(`likeCount-${productId}`, likeCount);

   		// æ›´æ–°é¡¯ç¤ºçš„æŒ‰è®šæ¬¡æ•¸
   		const likeCountElement = button.querySelector('.like-count');
   		likeCountElement.textContent = likeCount; // é¡¯ç¤ºæœ€æ–°çš„æŒ‰è®šæ•¸

   	// é¡¯ç¤ºæµ®ç¾æ–‡å­—
   	  const floatText = button.querySelector('.float-text');
   	  floatText.style.display = "inline"; // é¡¯ç¤ºæ–‡å­—
   	  floatText.classList.add("float-up"); // åŠ å…¥å‹•ç•«æ•ˆæœ

   	  // ç§»é™¤å‹•ç•«èˆ‡éš±è—æ–‡å­—
   	  setTimeout(() => {
   	    floatText.classList.remove("float-up");
   	    floatText.style.display = "none";
   	  }, 1000); // 1ç§’å¾Œéš±è—æ–‡å­—

   	  console.log(`Product ID: ${productId} - Like Count: ${likeCount}`); // å¯é¸çš„èª¿è©¦è¼¸å‡º
   	}
		
		
		
		
		// æ ¹æ“š status é¡¯ç¤ºå°æ‡‰çš„æ–‡å­—
		function getStatusText(status) {
  		switch (status) {
    	case 'active':
     	 return 'å¸³è™Ÿæ­£å¸¸ä½¿ç”¨ä¸­';
    	case 'deleted':
     	 return 'å¸³è™Ÿå·²åˆªé™¤';
    	case 'flagged':
     	 return 'å¸³è™Ÿç•°å¸¸';
    	default:
    	  return 'æœªçŸ¥ç‹€æ…‹';
 	 }
		}


		// å…¨åŸŸè®Šæ•¸ç”¨ä¾†è¿½è¹¤ç•™è¨€æ˜¯å¦å·²ç¶“åŠ è¼‰é
		let loadedComments = {};

		function toggleComments(reviewId) {
		  const commentsContainer = document.getElementById(`comments-${reviewId}`);
		  
		  // å¦‚æœç•™è¨€å€åŸŸæ˜¯éš±è—çš„ï¼Œé¡¯ç¤ºä¸¦åŠ è¼‰ç•™è¨€
		  if (commentsContainer.style.display === 'none' || commentsContainer.style.display === '') {
		    commentsContainer.style.display = 'block';
		    
		    // å¦‚æœç•™è¨€å°šæœªåŠ è¼‰éï¼Œå‰‡åŠ è¼‰ç•™è¨€
		    if (!loadedComments[reviewId]) {
		      loadComments(reviewId);
		    }
		  } else {
		    commentsContainer.style.display = 'none';
		  }
		}

		// åŠ è¼‰ç•™è¨€
		function loadComments(reviewId) {
		  fetch(`http://localhost:8081/reviewReply/repliesByReview/${reviewId}`)
		    .then(response => response.json())
		    .then(comments => {
		      const commentsContainer = document.getElementById(`comments-${reviewId}`);

		      // å¦‚æœå›æ‡‰ä¸­åŒ…å« message ä¸”ç‚º "æ­¤è²¼æ–‡å°šç„¡ä»»ä½•ç•™è¨€"ï¼Œé¡¯ç¤ºæ­¤è¨Šæ¯
		      if (comments && comments.length === 1 && comments[0].message) {
		        commentsContainer.innerHTML = `<p>${comments[0].message}</p>`;
		        return;
		      }

		      // å¦‚æœæ²’æœ‰ç•™è¨€ï¼Œé¡¯ç¤ºã€Œç›®å‰é‚„æ²’æœ‰ç•™è¨€ã€
		      if (!comments || comments.length === 0) {
		        commentsContainer.innerHTML = '<p>ç›®å‰é‚„æ²’æœ‰ç•™è¨€</p>';
		        return;
		      }

		      commentsContainer.innerHTML = ''; // æ¸…ç©ºç¾æœ‰ç•™è¨€

		      // è¿­ä»£ç•™è¨€ä¸¦ç”Ÿæˆ HTML
		      comments.forEach(comment => {
		        const commentElement = document.createElement('div');
		        commentElement.className = 'comment-item';

		        const userId = comment.userId;
		        const content = comment.content;
		        const createdAt = new Date(comment.createdAt).toLocaleString(); // æ ¼å¼åŒ–æ™‚é–“
		        const updatedAt = comment.updatedAt ? new Date(comment.updatedAt).toLocaleString() : 'ç„¡ä¿®æ”¹'; // æª¢æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹æ™‚é–“

		        // æˆªå–å‰10å€‹å­—é¡¯ç¤ºï¼Œä¸¦æ·»åŠ "æ›´å¤š"æ–‡å­—é€£çµ
		        const shortContent = content.length > 10 ? content.slice(0, 10) + '...' : content;
		        const fullContent = content; // å®Œæ•´å…§å®¹

		        commentElement.innerHTML = `
		          <div class="comment-header">
		            <span class="user-id"><strong>ç”¨æˆ¶ID:</strong> ${userId}</span>
		            <div class="comment-content">
		              <p><strong>ç•™è¨€å…§å®¹:</strong> 
		                <span class="content-preview">${shortContent}</span>
		                <span class="full-content" style="display:none;">${fullContent}</span>
		                <span class="more-link" style="display:${content.length > 10 ? 'inline' : 'none'}">æ›´å¤š</span>
		              </p>
		            </div>
		            <div class="comment-time">
		              <span><strong>å»ºç«‹æ™‚é–“:</strong> ${createdAt}</span>
		              <div>
		              <span><strong>æœ€æ–°ä¿®æ”¹æ™‚é–“:</strong> ${updatedAt}</span>
		            </div>
		          </div>

		          <div class="button-container">
		            <button class="edit-btn" data-id="${comment.id}">ç·¨è¼¯</button>
		            <button class="delete-btn" data-id="${comment.id}">åˆªé™¤</button>
		          </div>
		        `;

		        // ç›£è½ã€Œæ›´å¤šã€æ–‡å­—é€£çµé»æ“Šäº‹ä»¶
		        const moreLink = commentElement.querySelector('.more-link');
		        moreLink.addEventListener('click', () => {
		          const preview = commentElement.querySelector('.content-preview');
		          const full = commentElement.querySelector('.full-content');
		          const link = commentElement.querySelector('.more-link');
		          if (preview.style.display === 'none') {
		        	    // å¦‚æœç•¶å‰æ˜¯é¡¯ç¤ºå®Œæ•´å…§å®¹ï¼Œå‰‡åˆ‡æ›å›é è¦½æ¨¡å¼
		        	    preview.style.display = 'inline';
		        	    full.style.display = 'none';
		        	    link.textContent = 'è¼‰å…¥æ›´å¤š...';
		        	  } else {
		        	    // å¦‚æœç•¶å‰æ˜¯é¡¯ç¤ºé è¦½å…§å®¹ï¼Œå‰‡åˆ‡æ›åˆ°å®Œæ•´æ¨¡å¼
		        	    preview.style.display = 'none';
		        	    full.style.display = 'inline';
		        	    link.textContent = 'æ”¶èµ·...';
		        	  }
		         
		        });

		        // æŠŠç•™è¨€åŠ å…¥å®¹å™¨
		        commentsContainer.appendChild(commentElement);
		      });
		    
		      // æ¨™è¨˜ç•™è¨€å·²åŠ è¼‰
		      loadedComments[reviewId] = true;
		    })
		    .catch(error => {
		      console.error('åŠ è¼‰ç•™è¨€æ™‚å‡ºéŒ¯:', error);
		      const commentsContainer = document.getElementById(`comments-${reviewId}`);
		      commentsContainer.innerHTML = '<p>åŠ è¼‰ç•™è¨€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>'; // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
		    });
		}
		
		
		
		
		
	       // æ–°å¢ç•™è¨€
	        $(document).on('click', '.insert-btn', function () {
    const reviewId = $(this).data('review-id'); // å¾æŒ‰éˆ•çš„ data å±¬æ€§ç²å–å°æ‡‰çš„ reviewId

    Swal.fire({
        title: 'æ–°å¢ç•™è¨€',
        html: `
            <form id="replyForm" style="display: flex; flex-direction: column; gap: 16px;">
                <label for="reviewId">å°æ‡‰è²¼æ–‡ID:</label>
                <input type="text" id="reviewId" name="reviewId" value="${reviewId}" readonly required>
                
                <label for="userId">ç•™è¨€ç”¨æˆ¶ID:</label>
                <input type="text" id="userId" name="userId" required>
                
                <label for="content">ç•™è¨€å…§å®¹:</label>
                <textarea id="content" name="content" required></textarea>
            </form>
        `,
        showCancelButton: true,
        confirmButtonText: 'ç¢ºèªæ–°å¢',
        cancelButtonText: 'å–æ¶ˆ',
        preConfirm: () => {
            const form = document.getElementById('replyForm');
            if (!form.checkValidity()) {
                Swal.showValidationMessage('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼');
                return false;
            }
            const data = {
                reviewId: form.reviewId.value,
                userId: form.userId.value,
                content: form.content.value
            };
            return data;
        }
    }).then(result => {
        if (result.isConfirmed) {
            fetch('/reviewReply/insert?reviewId=' + result.value.reviewId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(result.value)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('æˆåŠŸ', 'æ–°å¢å›è¦†æˆåŠŸ', 'success').then(() => {
                        // å»¶é²å…©ç§’å¾Œåˆ·æ–°é é¢
                        setTimeout(() => {
                            window.location.reload(); // åˆ·æ–°é é¢
                        }, 2000); // å»¶é²å…©ç§’
                    });
                } else {
                    Swal.fire('éŒ¯èª¤', data.message || 'æ–°å¢å¤±æ•—', 'error');
                }
            })
            .catch(err => {
                Swal.fire('éŒ¯èª¤', 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤', 'error');
            });
        }
    });
});
	    	  
	         
	    	 
	     // ç·¨è¼¯ç•™è¨€
	        $(document).on('click', '.edit-btn', function () {
	          const id = $(this).data('id');
	          fetch(`/reviewReply/${id}`)
	            .then(res => res.json())
	            .then(data => {
	              // ç¢ºä¿è³‡æ–™ä¸­æœ‰ contentï¼Œä¸¦å¾è¿”å›çš„è³‡æ–™ä¸­ç²å– userId å’Œ reviewId
	              const content = data.content || "é€™æ˜¯é è¨­çš„ç•™è¨€å…§å®¹ï¼Œè«‹ä¿®æ”¹ã€‚";
	              const userId = data.userId;  // å¾è¿”å›çš„è³‡æ–™ä¸­ç²å– userId
	              const reviewId = data.reviewId || null;  // ç¢ºä¿ç²å¾— reviewId

	              Swal.fire({
	                title: 'ç·¨è¼¯ç•™è¨€',
	                html: `
	                  <form id="editReplyForm" style="display: flex; flex-direction: column; gap: 16px;">
	                    <label for="content">ç•™è¨€å…§å®¹:</label>
	                    <textarea id="content" name="content" required>${content}</textarea>
	                  </form>
	                `,
	                showCancelButton: true,
	                confirmButtonText: 'ç¢ºèªä¿®æ”¹',
	                cancelButtonText: 'å–æ¶ˆ',
	                preConfirm: () => {
	                  const form = document.getElementById('editReplyForm');
	                  const content = form.content.value;
	                  if (!content) {
	                    Swal.fire('éŒ¯èª¤', 'ç•™è¨€å…§å®¹ä¸å¯ç‚ºç©º', 'error');
	                    return false;
	                  }
	                  // è¿”å›æ‰€éœ€çš„è³‡æ–™ï¼šcontentã€userIdã€reviewId
	                  return { content, userId, reviewId };
	                }
	              }).then(result => {
	                if (result.isConfirmed) {
	                  // ä½¿ç”¨ result.value ä¾†å–å¾—è³‡æ–™
	                  const form = document.getElementById('editReplyForm');
	                  const content = form.content.value;
	                  
	                  // ç™¼é€ PUT è«‹æ±‚ï¼Œå°‡ userId å’Œ reviewId åŒ…å«åœ¨å…§
	                  fetch(`/reviewReply/${id}`, {
	                    method: 'PUT',
	                    headers: { 'Content-Type': 'application/json' },
	                    body: JSON.stringify({
	                      content: content,
	                      userId: result.value.userId,  // ä½¿ç”¨å‹•æ…‹ç²å¾—çš„ userId
	                      reviewId: result.value.reviewId  // ä½¿ç”¨å‹•æ…‹ç²å¾—çš„ reviewId
	                    })
	                  })
	                  .then(res => res.json())
	                  .then(data => {
	                    if (data.status === "success") {
	                      Swal.fire('æˆåŠŸ', 'ç•™è¨€ä¿®æ”¹æˆåŠŸ', 'success').then(() => {
	                        // å»¶é²å…©ç§’å¾Œåˆ·æ–°é é¢
	                        setTimeout(() => {
	                          window.location.reload(); // åˆ·æ–°é é¢
	                        }, 2000); // å»¶é²å…©ç§’
	                      });
	                    } else {
	                      Swal.fire('éŒ¯èª¤', data.message || 'ä¿®æ”¹å¤±æ•—', 'error');
	                    }
	                  })
	                  .catch(error => {
	                    Swal.fire('éŒ¯èª¤', 'è«‹æ±‚ç™¼ç”ŸéŒ¯èª¤', 'error');
	                  });
	                }
	              });
	            })
	            .catch(error => {
	              console.error('API éŒ¯èª¤:', error);
	              Swal.fire('éŒ¯èª¤', 'ç„¡æ³•å–å¾—ç•™è¨€è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
	            });
	        });
	     
	     
	     
	     // åˆªé™¤ç•™è¨€
	        $(document).on('click', '.delete-btn', function () {
	          const replyId = $(this).data('id'); // å¾ data-id ä¸­è®€å– replyId
	          Swal.fire({
	            title: 'ç¢ºå®šåˆªé™¤é€™æ¢ç•™è¨€å—?',
	            text: "åˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©",
	            icon: 'warning',
	            showCancelButton: true,
	            confirmButtonText: 'ç¢ºå®šåˆªé™¤',
	            cancelButtonText: 'å–æ¶ˆ'
	          }).then(result => {
	            if (result.isConfirmed) {
	              // ä½¿ç”¨æ‚¨æŒ‡å®šçš„è·¯å¾‘ä¾†ç™¼é€ DELETE è«‹æ±‚
	              fetch(`/reviewReply/delete?replyId=${replyId}`, { method: 'DELETE' })
	                .then(res => res.json())
	                .then(data => {
	                  if (data.success) {  // ç¢ºèªæˆåŠŸæ¨™èªŒï¼Œæ ¹æ“šå¾Œç«¯çš„éŸ¿æ‡‰èª¿æ•´
	                    Swal.fire('æˆåŠŸ', 'ç•™è¨€åˆªé™¤æˆåŠŸ', 'success').then(() => {
	                      setTimeout(() => {
	                        // åˆ·æ–°é é¢æˆ–æ›´æ–° DataTable
	                        window.location.reload(); // åˆ·æ–°é é¢
	                        // å¦‚æœä½¿ç”¨ DataTableï¼Œå¯ä»¥ç”¨é€™è¡Œä¾†æ›´æ–°è³‡æ–™ï¼š
	                        // $('#reviewRepliesTable').DataTable().ajax.reload();
	                      }, 2000);
	                    });
	                  } else {
	                    Swal.fire('éŒ¯èª¤', data.message || 'åˆªé™¤å¤±æ•—', 'error');
	                  }
	                })
	                .catch(error => {
	                  Swal.fire('éŒ¯èª¤', 'åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
	                });
	            }
	          });
	        });
		
		
		
		
		
		
		
		
		
    // ç·¨è¼¯åŠŸèƒ½
	async function editReview(reviewId) {
    try {
        // ç²å–ç¾æœ‰çš„æ•¸æ“š
        const response = await fetch(`http://localhost:8081/review/integer/${reviewId}`);
        if (!response.ok) {
            throw new Error("ç„¡æ³•ç²å–è©•åƒ¹æ•¸æ“š");
        }
        const review = await response.json();

        // ä½¿ç”¨ SweetAlert é¡¯ç¤ºç·¨è¼¯è¡¨å–®
        Swal.fire({
            title: "ç·¨è¼¯è©•åƒ¹",
            html: `
            <form id="EditReviewForm" style="display: flex; flex-direction: column; gap: 16px;">
                <div style="margin-bottom: 16px;">
                    <label for="userId">ä½¿ç”¨è€… ID:</label>
                    <input type="text" id="userId" name="userId" value="${review.userId}" required>
                </div>

                <div style="margin-bottom: 16px;">
                    <label for="product">è²¼æ–‡åç¨±:</label>
                    <input type="text" id="product" name="product" value="${review.product}" required>
                </div>

                <div style="margin-bottom: 16px;">
                    <label for="productId">è²¼æ–‡ç·¨ç¢¼:</label>
                    <input type="text" id="productId" name="productId" value="${review.productId}" required>
                </div>

                <!-- åœ–ç‰‡ä¸Šå‚³ -->
                <div style="margin-bottom: 16px;">
                    <label for="productPicture">ä¸Šå‚³åœ–ç‰‡:</label>
                    <input type="file" id="productPicture" name="productPicture" accept="image/*" style="margin-bottom: 8px;">
                    ${review.productPictureBase64 ? 
                    `<img src="data:image/jpeg;base64,${review.productPictureBase64}" alt="Current Image" style="width: 120px; height: 120px; object-fit: cover; border: 1px solid #ccc; border-radius: 8px;">`
                    : ''}
                </div>

                <div style="margin-bottom: 16px;">
                    <label for="content">å…§å®¹:</label>
                    <textarea id="content" name="content" style="width: 100%; resize: vertical;" rows="5" required></textarea>
                </div>

                <div style="margin-bottom: 16px;">
                    <label for="rating">æ¨è–¦æ˜Ÿæ˜Ÿ:</label>
                    <div id="ratingStars">
                        ${Array(5).fill(0).map((_, i) => `
                        <i class="fa fa-star" style="color: ${i < review.rating ? 'gold' : 'gray'};" onclick="setRating(${i + 1})"></i>
                        `).join('')}
                    </div>
                    <input type="hidden" id="rating" name="rating" value="${review.rating}" required>
                </div>

                <div style="margin-bottom: 16px;">
                    <label for="status">ç™¼è¡¨è²¼æ–‡å¸³è™Ÿç‹€æ…‹:</label>
                    <select id="status" name="status" required>
                        <option value="active" ${review.status === 'active' ? 'selected' : ''}>å¸³è™Ÿæ­£å¸¸ä½¿ç”¨ä¸­</option>
                        <option value="deleted" ${review.status === 'deleted' ? 'selected' : ''}>å¸³è™Ÿå·²åˆªé™¤</option>
                    </select>
                </div>
            </form>
            `,
            showCancelButton: true,
            confirmButtonText: "ç¢ºèªæäº¤",
            cancelButtonText:"å–æ¶ˆ",
         // ç¢ºä¿åœ–ç‰‡æ˜¯ base64 å­—ç¬¦ä¸²
            preConfirm: () => {
                const form = document.getElementById("EditReviewForm");
                const formData = new FormData(form);

                const productPictureInput = document.getElementById("productPicture");
                if (productPictureInput.files.length > 0) {
                    return new Promise((resolve, reject) => {
                        const file = productPictureInput.files[0];
                        const reader = new FileReader();
                        reader.onload = () => {
                            formData.set("productPicture", reader.result.split(",")[1]); // åªå– Base64 éƒ¨åˆ†
                            resolve(formData);
                        };
                        reader.onerror = () => reject(new Error("åœ–ç‰‡è®€å–å¤±æ•—"));
                        reader.readAsDataURL(file);
                    });
                } else {
                    return Promise.resolve(formData);  // æ²’æœ‰åœ–ç‰‡æ™‚ï¼Œç›´æ¥æäº¤è¡¨å–®
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const formData = Object.fromEntries(result.value);
                fetch(`http://localhost:8081/review/${reviewId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(formData)
                })
                .then((response) => response.json())
                .then((data) => {
                    if (data.status === "success") {
                        Swal.fire("æˆåŠŸ", "è²¼æ–‡æ›´æ–°æˆåŠŸï¼", "success").then(() => {
                            setTimeout(() => {
                                window.location.reload(); // åˆ·æ–°é é¢
                            }, 2000); // å»¶é²å…©ç§’
                        });
                    } else {
                        Swal.fire("å¤±æ•—", data.message || "è²¼æ–‡æ›´æ–°å¤±æ•—", "error");
                    }
                })
                .catch((error) => {
                    Swal.fire("éŒ¯èª¤", error.message, "error");
                });
            }
        });
    } catch (error) {
        Swal.fire("éŒ¯èª¤", error.message, "error");
    }
}
 

// è™•ç†è©•åˆ†æ˜Ÿæ˜Ÿé»æ“Š
function setRating(rating) {
  const stars = document.querySelectorAll("#ratingStars i");
  stars.forEach((star, index) => {
    star.style.color = index < rating ? "gold" : "gray";
  });
  document.getElementById("rating").value = rating;
}



    // ç¢ºèªåˆªé™¤è©•åƒ¹
    async function confirmDelete(userId, productId) {
  const result = await Swal.fire({
    title: 'ç¢ºå®šè¦åˆªé™¤æ­¤è²¼æ–‡å—ï¼Ÿ',
    text: 'åˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸï¼',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'ç¢ºå®šåˆªé™¤',
    cancelButtonText: 'å–æ¶ˆ'
  });

  if (result.isConfirmed) {
    try {
      const response = await fetch(`/review/delete?userId=${userId}&productId=${productId}`, {
        method: 'DELETE',
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `deleteUserId=${encodeURIComponent(userId)}&deleteProductId=${encodeURIComponent(productId)}`,
      });

      if (response.ok) {
        Swal.fire({
          title: 'åˆªé™¤æˆåŠŸï¼',
          text: 'è©²è²¼æ–‡å·²è¢«æˆåŠŸåˆªé™¤ã€‚',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        }).then(() => window.location.reload());
      } else {
        Swal.fire({
          title: 'åˆªé™¤å¤±æ•—ï¼',
          text: 'è«‹ç¨å¾Œå†è©¦ã€‚',
          icon: 'error',
          timer: 2000,
          showConfirmButton: false
        });
      }
    } catch (error) {
      console.error("åˆªé™¤å¤±æ•—ï¼š", error);
      Swal.fire({
        title: 'ç³»çµ±éŒ¯èª¤ï¼',
        text: 'è«‹ç¨å¾Œå†è©¦ã€‚',
        icon: 'error',
        timer: 2000,
        showConfirmButton: false
      });
    }
  }
}
    
    


    let currentIndex = 0; // ç•¶å‰é¡¯ç¤ºçš„è²¼æ–‡ç´¢å¼•
    const itemsPerPage = 9; // æ¯æ¬¡é¡¯ç¤ºçš„è²¼æ–‡æ•¸é‡

    function displayMoreReviews() {
      const reviewsContainer = document.getElementById("reviews");
      const loadMoreButton = document.getElementById("loadMoreButton");


      
      // ç²å–ä¸‹ä¸€æ‰¹è²¼æ–‡
      const nextReviews = allReviews.slice(currentIndex, currentIndex + itemsPerPage);
      nextReviews.forEach((review) => addReview(review));

      currentIndex += itemsPerPage;

      // å¦‚æœæ‰€æœ‰è²¼æ–‡å·²é¡¯ç¤ºï¼Œéš±è—ã€ŒæŸ¥çœ‹æ›´å¤šã€æŒ‰éˆ•
      if (currentIndex >= allReviews.length) {
        loadMoreButton.style.display = "none";
      }
    }

    // å¾å¾Œç«¯ç²å–æ‰€æœ‰è²¼æ–‡
    let allReviews = [];
    fetch("../review")
      .then((response) => response.json())
      .then((reviews) => {
        allReviews = reviews;
        displayMoreReviews(); // åˆå§‹é¡¯ç¤ºç¬¬ä¸€æ‰¹è²¼æ–‡
      })
      .catch((error) => {
        console.error("ç„¡æ³•å–å¾—è²¼æ–‡è³‡æ–™ï¼š", error);
      });

    // ç¶å®šã€ŒæŸ¥çœ‹æ›´å¤šã€æŒ‰éˆ•äº‹ä»¶
    document.getElementById("loadMoreButton").addEventListener("click", displayMoreReviews);

 // æ§åˆ¶æœå°‹æ¡†é¡¯ç¤º/éš±è—
    function toggleSearchBox() {
      const searchInput = document.getElementById("searchInput");
      searchInput.style.display = searchInput.style.display === "none" ? "block" : "none";
      searchInput.focus();
    }

    // æœå°‹åŠŸèƒ½
    function searchReviews() {
      const searchInput = document.getElementById("searchInput").value.toLowerCase();
      const reviewsContainer = document.getElementById("reviews");

      // æ¸…ç©ºåŸæœ‰é¡¯ç¤ºçš„è²¼æ–‡
      reviewsContainer.innerHTML = "";
      
     


      // éæ¿¾ç¬¦åˆæ¢ä»¶çš„è²¼æ–‡
      const filteredReviews = allReviews.filter((review) =>
        review.product.toLowerCase().includes(searchInput) ||
        review.userId.toString().includes(searchInput) ||
        review.productId.toString().includes(searchInput) ||
        review.content.toLowerCase().includes(searchInput)
      );

      if (filteredReviews.length === 0) {
        reviewsContainer.innerHTML = `<p style="color: white;">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„çµæœã€‚</p>`;
      } else {
        filteredReviews.forEach((review) => addReview(review));
      }
    }

    // ç¶å®šæœå°‹æ¡†æŒ‰éµäº‹ä»¶ï¼ˆæŒ‰ä¸‹ Enter è§¸ç™¼æœå°‹ï¼‰
    document.getElementById("searchInput").addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        searchReviews();
      }
    });

   
  </script>
</body>
</html>
